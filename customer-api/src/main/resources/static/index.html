<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>GraphQL Client</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 20px; background-color: #f4f7f9; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        ul { list-style-type: none; padding: 0; }
        li { background-color: #fff; border: 1px solid #ddd; margin-top: -1px; padding: 12px; }
        li:first-child { border-radius: 5px 5px 0 0; }
        li:last-child { border-radius: 0 0 5px 5px; }
        form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
        input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .form-group { display: flex; flex-direction: column; }
        .full-width { grid-column: 1 / -1; }
        #status { margin-top: 15px; padding: 10px; border-radius: 5px; font-weight: bold; display: none; }
        .success { background-color: #d4edda; color: #155724; display: block; }
        .error { background-color: #f8d7da; color: #721c24; display: block; }
    </style>
</head>
<body>

<div class="container">
    <h1>Quản lý Sản phẩm</h1>

    <h2>Danh sách sản phẩm</h2>
    <button id="fetchProductsBtn">Tải danh sách sản phẩm (Giá thấp đến cao)</button>
    <ul id="productList">
        </ul>

    <h2>Thêm sản phẩm mới</h2>
    <form id="createProductForm">
        <div class="form-group">
            <label for="title">Tên sản phẩm:</label>
            <input type="text" id="title" required>
        </div>
        <div class="form-group">
            <label for="price">Giá:</label>
            <input type="number" id="price" required>
        </div>
        <div class="form-group">
            <label for="quantity">Số lượng:</label>
            <input type="number" id="quantity" required>
        </div>
        <div class="form-group">
            <label for="desc">Mô tả:</label>
            <input type="text" id="desc">
        </div>
        <div class="form-group">
            <label for="userId">ID Người bán:</label>
            <input type="number" id="userId" required placeholder="Ví dụ: 1">
        </div>
        <div class="form-group">
            <label for="categoryIds">IDs Danh mục (phân cách bởi dấu phẩy):</label>
            <input type="text" id="categoryIds" required placeholder="Ví dụ: 1,2">
        </div>
        <div class="form-group full-width">
            <button type="submit">Tạo sản phẩm</button>
        </div>
    </form>
    <div id="status"></div>
</div>

<script>
    const API_ENDPOINT = '/graphql';

    /**
     * Hàm chung để gọi API GraphQL bằng fetch (AJAX)
     * @param {string} query - Chuỗi query hoặc mutation của GraphQL
     * @param {object} variables - Các biến cho query (nếu có)
     * @returns {Promise<any>}
     */
    async function callGraphQL(query, variables = {}) {
        const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                query: query,
                variables: variables
            })
        });
        return response.json();
    }

    const productListEl = document.getElementById('productList');
    const statusEl = document.getElementById('status');
    const createForm = document.getElementById('createProductForm');

    /**
     * Hàm lấy và hiển thị danh sách sản phẩm
     */
    async function fetchAndRenderProducts() {
        const getProductsQuery = `
            query {
                allProductsSortedByPrice {
                    id
                    title
                    price
                    user {
                        fullname
                    }
                }
            }
        `;
        try {
            const result = await callGraphQL(getProductsQuery);
            if (result.errors) {
                throw new Error(result.errors.map(e => e.message).join('\n'));
            }
            const products = result.data.allProductsSortedByPrice;

            productListEl.innerHTML = ''; // Xóa danh sách cũ

            if (products.length === 0) {
                 productListEl.innerHTML = '<li>Không có sản phẩm nào.</li>';
                 return;
            }

            products.forEach(product => {
                const li = document.createElement('li');
                li.textContent = `Tên: ${product.title} - Giá: ${product.price.toLocaleString()} VNĐ - Người bán: ${product.user.fullname}`;
                productListEl.appendChild(li);
            });
        } catch (error) {
            statusEl.textContent = `Lỗi khi tải sản phẩm: ${error.message}`;
            statusEl.className = 'error';
        }
    }

    // Gán sự kiện cho nút "Tải danh sách sản phẩm"
    document.getElementById('fetchProductsBtn').addEventListener('click', fetchAndRenderProducts);

    // Gán sự kiện cho form "Tạo sản phẩm"
    createForm.addEventListener('submit', async (event) => {
        event.preventDefault(); // Ngăn form gửi đi theo cách truyền thống

        // Lấy dữ liệu từ form
        const title = document.getElementById('title').value;
        const price = parseFloat(document.getElementById('price').value);
        const quantity = parseInt(document.getElementById('quantity').value, 10);
        const desc = document.getElementById('desc').value;
        const userId = parseInt(document.getElementById('userId').value, 10);
        const categoryIds = document.getElementById('categoryIds').value.split(',').map(id => parseInt(id.trim(), 10));

        // Định nghĩa mutation và biến
        const createProductMutation = `
            mutation CreateProduct($input: ProductInput!) {
                createProduct(input: $input) {
                    id
                    title
                }
            }
        `;

        const variables = {
            input: {
                title: title,
                price: price,
                quantity: quantity,
                desc: desc,
                userId: userId,
                categoryIds: categoryIds
            }
        };

        // Gọi API
        try {
            const result = await callGraphQL(createProductMutation, variables);
            if (result.errors) {
                throw new Error(result.errors.map(e => e.message).join('\n'));
            }

            const createdProduct = result.data.createProduct;
            statusEl.textContent = `Tạo thành công sản phẩm: "${createdProduct.title}" (ID: ${createdProduct.id})`;
            statusEl.className = 'success';

            createForm.reset(); // Xóa trắng form
            fetchAndRenderProducts(); // Tải lại danh sách sản phẩm

        } catch (error) {
            statusEl.textContent = `Lỗi khi tạo sản phẩm: ${error.message}`;
            statusEl.className = 'error';
        }
    });

</script>
</body>
</html>